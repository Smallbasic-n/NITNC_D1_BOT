@page "/ChankAdd"
@using System.Globalization
@using System.Text
@using ImagawaYoshimoto.Data
@using Microsoft.EntityFrameworkCore
@implements IDisposable
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@rendermode InteractiveServer

<PageTitle>チャンク | エイブラハム・リンカン | 今川義元</PageTitle>
<h3>クラウン チャンクで英単語 Standard 第2版 標準 のデータを登録します．</h3>

@if (error)
{
    <RadzenAlert Variant="Variant.Flat" AlertStyle="AlertStyle.Warning" Icon="warning" Shade="Shade.Lighter" Size="AlertSize.Small" AllowClose=false>
        @errorMessage
    </RadzenAlert>
}

<RadzenAlert Variant="Variant.Flat" AlertStyle="AlertStyle.Info" Icon="info" Shade="Shade.Lighter" Size="AlertSize.Small" AllowClose=false>
    ここでは，CSVファイルでアップロードしていただきます．Excelなどで作成されるかと思いますが，次の注意事項をお守り下さい．<br/>
    ・ファイルは1STEPごとに作成し，1ファイルごとアップロードしてください．<br/>
    ・A列1行目からはじめ，1行目から問題を入力して下さい．キャプションなどは不要です．<br/>
    ・A列から順に，チャンクの問題，その日本語，解答　の順番としてください．<br/>
</RadzenAlert>
<RadzenRow AlignItems="AlignItems.End" Wrap="FlexWrap.Wrap" Gap="1rem" class="rz-p-sm-12">
    <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
        <RadzenFormField Text="STEP番号" Style="width: 100%;">
            <RadzenNumeric TValue="int" Change="i => StepNo=i"></RadzenNumeric>
        </RadzenFormField>
    </RadzenColumn>
    <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
        <RadzenFormField Text="データファイル(csv)" Style="width: 100%;">
            <RadzenFileInput TValue="string" Change="s => ChankData=s"></RadzenFileInput>
        </RadzenFormField>
    </RadzenColumn>
</RadzenRow>
<RadzenButton Click="SubmitChank">チャンクの問題をリンカンに登録する</RadzenButton>
@code {
    private int StepNo { get; set; } = 0;
    private string ChankData { get; set; }
    private bool busy = false;
    private bool error = false;
    private string errorMessage = "";
    private ApplicationDbContext Context;
    private void SubmitChank(MouseEventArgs obj)
    {
        busy = true;
        Context = DbFactory.CreateDbContext();
        //Context.Database.BeginTransaction();
        error = false;
        if (ChankData.IndexOf("data:text/csv;base64,") == -1)
        {
            error = true;
            errorMessage = "CSVファイルをアップロードしてください．";
            return;
        }
        var data = Encoding.UTF8.GetString(Convert.FromBase64String(ChankData.Replace("data:text/csv;base64,",""))).Replace('\r','\n').Replace("\r\n","\n").Split('\n');
        for (int i = 0; i < data.Length; i++)
        {
            if (string.IsNullOrWhiteSpace(data[i])) continue;
            if (i == 0) data[0] += ",\"Id\",\"Step\"";
            else data[i] += ",\"0\",\"0\"";
            Console.WriteLine("Index: {0} Data: {1}",i,data[i]);
        }
        
        var editedCSV = "";
        foreach (var dt1 in data)
        {
            editedCSV += dt1 + "\n";
        }

        editedCSV = editedCSV[..^1];
        var parse = new CsvHelper.CsvReader(new StringReader(editedCSV),CultureInfo.CurrentCulture);
        parse.Read();
        parse.ReadHeader();
        var res = parse.GetRecords<Data.ChankQuestions>().Select(x => new Data.ChankQuestions(){ Answer = x.Answer, English = x.English, Japanese = x.Japanese, Step = StepNo});
        foreach (var data1 in res)
        {
            Context.Add(data1);
        }

        Context.SaveChanges();
        //Console.WriteLine(data);
        /*
        foreach (var dt1 in res)
        {
            var data1=dt1.Split(',');
            //Context.Database.BeginTransaction();
            await Context.Database.ExecuteSqlRawAsync("insert into \"ChankQuestions\" (japanese, english, answer) values ({0},{1},{2});", data1[1], data1[2], data1[0]);
            //Context.Database.CommitTransaction();
        }*/
        //
    }

    public void Dispose(){}

    public class ChankQuestions
    {
        public int id {get;set;}
        public string japanese {get;set;}
        public string english {get;set;}
        public string answer {get;set;}

        public ChankQuestions(int id_,string japanese_,string english_,string answer_)
        {
            this.id = id_;
            this.japanese = japanese_;
            this.english = english_;
            this.answer = answer_;
        }
    }
    
}